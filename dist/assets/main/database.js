function db(){this.db_name="haccp",this.db_version="1.0",this.db_size=5242880,this.database=localStorage.getItem("database"),this.appVersion=localStorage.getItem("app-version"),this.data=[],this.query=!1,this.collections=[],this.tables=["settings","tasks","haccp_category","haccp_items","forms","registration","form_item","sync_query","reports","flowchart"]}function _fetchResults(a,b){db_data=b.rows}function createDesignDoc(a,b){var c={_id:"_design/"+a,views:{}};return c.views[a]={map:b.toString()},c}var query=!1,db_data=[];db.prototype.asyncExecute=function(a,b,c){void 0!=a.sql&&b<a.data.length&&this.asyncExecute(a,parseInt(b)+1)},db.prototype.lazyQuery=function(a,b,c,d){if(1==logout_flag)return!1;a&&void 0!=b&&b.length>0?this.bulkDocs(a,b,c,d):"function"!=typeof c&&void 0!=window[c]?d?window[c](d):window[c]():c&&"function"==typeof c&&(d?c(d):c())},db.prototype.bulkDocs=function(a,b,c,d){if(!a)return null;for(var e=[],f=this,g=0;g<b.length;g++){var h=g;!function(c,f){e[f]=new Promise(function(e,g){c.collections[a].get(String(b[f]._id||b[f].id),function(a,c){a&&(b[f].timestamp=(new Date).toJSON(),e(!1)),!a&&c&&c._rev?(b[f]=jQuery.extend(c,b[f]),b[f]._id=String(b[f]._id),d&&d._deleted&&(console.log("deleted"),b[f]._deleted=!0),e(!0)):e(!1)})})}(f,h)}Promise.all(e).then(function(){f.collections[a].bulkDocs(b,function(a,b){"function"!=typeof c&&void 0!=window[c]?d?window[c](d,b):window[c](b):c&&"function"==typeof c&&(d?c(d,b):c(b))})})},db.prototype.lazyQuerySync=function(a,b,c,d){if(1==logout_flag)return!1;void 0!=a&&void 0!=b&&b.length>0?this.bulkDocs(a,b,c,d):void 0!=window[c]&&(void 0!=d?window[c](d):window[c]())},db.prototype.clean=function(){query=!1,db_data=[]},db.prototype._execQuery=function(a){return query?void a.executeSql(query,[],_fetchResults,this.dbErrorHandle):!1},db.prototype.createView=function(a,b,c){var d=createDesignDoc(b,c);this.collections[a].put(d)},db.prototype.createTables=function(){localStorage.setItem("database",!0),this.database=!0,localStorage.setItem("app-version",settings.version),this.appVersion=settings.version;for(var a=this,b=0;b<this.tables.length;b++){var c=b;!function(b){a.collections[a.tables[b]]=new PouchDB(a.db_name+"_"+a.tables[b],{skip_setup:!0});var c=createDesignDoc("sort_index",function(a){emit(a.timestamp)});a.collections[a.tables[b]].put(c)}(c)}this.createView("sync_query","get_sync",function(a){a.executed||emit(a.timestamp)})},db.prototype.dropDb=function(){this.db.transaction(this.dbDropTables,this.dbErrorHandle,function(){return!0})},db.prototype.dbDropTables=function(){this.database=!1;for(var a=0;a<localStorage.length;a++)"user_email"!=localStorage.key(a)&&localStorage.removeItem(localStorage.key(a));for(var b=[],a=0;a<this.tables.length;a++){var c=this.collections[this.tables[a]];b[a]=new Promise(function(a,b){c?c.destroy(a):a(!0)})}return Promise.all(b)},db.prototype.InitDB=function(){this.createTables()},db.prototype.dbCreateTables=function(a){this.dbDropTables(a),localStorage.setItem("database",!0),this.database=!0,localStorage.setItem("app-version",settings.version),this.appVersion=settings.version},db.prototype.dbErrorHandle=function(a){console.log("Error processing SQL: ",a),console.log("query: ",query);var b=this;this.dbDropTables().then(function(){b.createTables(),window.location.reload()})},db.prototype.dbSuccessHandle=function(){return!0},db.prototype.getDbInstance=function(a){return a?this.collections[a]:!1},db.prototype.clearCollection=function(a,b){var c=this;this.collections[a].query("sort_index",function(d,e){c.bulkDocs(a,e.rows,function(){b&&b()},{_deleted:!0})})};