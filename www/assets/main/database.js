"use strict";function db(){this.db_name="haccp",this.db_version="1.0",this.db_size=50,this.database=localStorage.getItem("database"),this.appVersion=localStorage.getItem("app-version"),this.data=[],this.query=!1,this.collections=[],this.tables=["tasks","haccp_items","forms","registration","form_item","sync_query","reports","flowchart","settings"],this.localStore=["app-version","company_join_date","company_name","contact_name","database","role","user_data","user_name"],PouchDB.plugin(Erase)}function _fetchResults(a,b){db_data=b.rows}function createDesignDoc(a,b){var c={_id:"_design/"+a,views:{}};return c.views[a]={map:b.toString()},c}var query=!1,db_data=[];db.prototype.asyncExecute=function(a,b,c){void 0!=a.sql&&b<a.data.length&&this.asyncExecute(a,parseInt(b)+1)},db.prototype.lazyQuery=function(a,b,c,d){if(1==logout_flag)return!1;a&&void 0!=b&&b.length>0?this.bulkDocs(a,b,c,d):"function"!=typeof c&&void 0!=window[c]?d?window[c](d):window[c]():c&&"function"==typeof c&&(d?c(d):c())},db.prototype.bulkDocs=function(a,b,c,d){if(!a)return null;for(var e=[],f=this,g=0;g<b.length;g++){var h=g;!function(c,f){e[f]=new Promise(function(e,g){c.collections[a].get(String(b[f]._id||b[f].id),function(g,h){g&&(b[f].timestamp=(new Date).toJSON(),e(!1)),!g&&h&&h._rev?(b[f]=jQuery.extend(h,b[f]),b[f]._id=String(b[f]._id),d&&d._deleted&&c.collections[a].remove(h),e(!0)):e(!1)})})}(f,h)}Promise.all(e).then(function(){return d&&d._deleted?void("function"!=typeof c&&void 0!=window[c]?window[c]():c&&"function"==typeof c&&c()):void f.collections[a].bulkDocs(b,function(a,b){"function"!=typeof c&&void 0!=window[c]?d?window[c](d,b):window[c](b):c&&"function"==typeof c&&(d?c(d,b):c(b))})})},db.prototype.lazyQuerySync=function(a,b,c,d){if(1==logout_flag)return!1;void 0!=a&&void 0!=b&&b.length>0?this.bulkDocs(a,b,c,d):void 0!=window[c]&&(void 0!=d?window[c](d):window[c]())},db.prototype.clean=function(){query=!1,db_data=[]},db.prototype._execQuery=function(a){return query?void a.executeSql(query,[],_fetchResults,this.dbErrorHandle):!1},db.prototype.createView=function(a,b,c){var d=createDesignDoc(b,c);this.collections[a].putIfNotExists(d)},db.prototype.createCollection=function(a,b){if(a==this.tables.length)return void(b&&b());var c=this;if(c.collections[c.tables[a]])this.createCollection(a+1,b);else{var d={auto_compaction:!0,skip_setup:!0};window.openDatabase&&(d.adapter="websql"),new PouchDB(c.db_name+"_"+c.tables[a],d).then(function(d){return c.collections[c.tables[a]]=d,c.collections[c.tables[a]].adapter?c.createCollection(a+1,b):c.collections[c.tables[a]]=new PouchDB(c.db_name+"_"+c.tables[a],{skip_setup:!0}).then(function(d){c.collections[c.tables[a]]=d,c.createCollection(a+1,b)}),d})["catch"](function(a){console.log(a)})}},db.prototype.createTables=function(a){localStorage.setItem("database",!0),this.database=!0,localStorage.setItem("app-version",settings.version),this.appVersion=settings.version;var b=this,c=0,d=new Promise(function(d,e){b.createCollection(c,function(){for(var c=0;c<b.tables.length;c++)b.createView(b.tables[c],"sort_index",function(a){emit(a.timestamp)});b.createView("sync_query","get_sync",function(a){a.executed||emit(a.timestamp)}),a&&window.location.reload(),d(!0)})});return d},db.prototype.dropDb=function(){this.db.transaction(this.dbDropTables,this.dbErrorHandle,function(){return!0})},db.prototype.dbDropTables=function(){this.database=!1;for(var a=this,b=0;b<localStorage.length;b++)this.localStore.indexOf(localStorage.key(b))>-1&&localStorage.removeItem(localStorage.key(b));var c=[];console.log("dbDropTables",this.tables);for(var b=0;b<this.tables.length;b++){console.log("dbDropTables for",this.tables[b]);var d=b;!function(b){c[b]=new Promise(function(c,d){var e=a.collections[a.tables[b]];e||(e=new PouchDB(a.db_name+"_"+a.tables[b],{skip_setup:!0})),e?e.destroy(function(a,b){a&&console.log(a),c(!0)}):c(!1)})}(d)}return Promise.all(c).then(function(a){return a.length==c.length?a:void 0})},db.prototype.InitDB=function(){var a=!1;return(!this.appVersion||this.appVersion&&settings.rebuild&&this.appVersion.replace(/\./g,"")<settings.rebuild.replace(/\./g,""))&&(a=!0),console.log("isCreateDB",a),a?void this.dbDropTables().then(function(a){localStorage.setItem("app-version",settings.version),window.location.reload()}):this.createTables()},db.prototype.dbCreateTables=function(a){this.dbDropTables(a),localStorage.setItem("database",!0),this.database=!0,localStorage.setItem("app-version",settings.version),this.appVersion=settings.version},db.prototype.dbErrorHandle=function(a){console.log("Error processing SQL: ",a),console.log("query: ",query);this.dbDropTables().then(function(){window.location.reload()})},db.prototype.dbSuccessHandle=function(){return!0},db.prototype.getDbInstance=function(a){return a&&this.collections[a]?this.collections[a]:!1},db.prototype.clearCollection=function(a,b){this.collections[a]?this.collections[a].erase({},function(){b&&b({deleted:!0})}):b&&b({deleted:!0})};