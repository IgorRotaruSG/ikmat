function localStorageDB(a,b){function c(){delete C[z],B=null}function d(){var a=0;for(var b in B.tables)B.tables.hasOwnProperty(b)&&a++;return a}function e(a){return!!B.tables[a]}function f(a){e(a)||t("The table '"+a+"' does not exist.")}function g(a,b){B.tables[a]={fields:b,auto_increment:1},B.data[a]={}}function h(a){delete B.tables[a],delete B.data[a]}function i(a){B.tables[a].auto_increment=1,B.data[a]={}}function j(a){var b=0;for(var c in B.data[a])B.data[a].hasOwnProperty(c)&&b++;return b}function k(a,b){return b.ID=B.tables[a].auto_increment,B.data[a][B.tables[a].auto_increment]=b,B.tables[a].auto_increment++,b.ID}function l(a,b){for(var c=null,d=[],e=null,f=0;f<b.length;f++)c=b[f],e=B.data[a][c],d.push(u(e));return d}function m(a,b,c){var d=[],e=!1,f=null;for(var g in B.data[a])if(B.data[a].hasOwnProperty(g)){f=B.data[a][g],e=!0;for(var h in b)if(b.hasOwnProperty(h))if("string"==typeof b[h]){if(f[h].toString().toLowerCase()!=b[h].toString().toLowerCase()){e=!1;break}}else if(f[h]!=b[h]){e=!1;break}if(e&&d.push(g),d.length==c)break}return d}function n(a,b,c){var d=[],e=null;for(var f in B.data[a])if(B.data[a].hasOwnProperty(f)&&(e=B.data[a][f],1==b(u(e))&&d.push(f),d.length==c))break;return d}function o(a,b){var c=[];for(var d in B.data[a])if(B.data[a].hasOwnProperty(d)&&(c.push(d),c.length==b))break;return c}function p(a,b){for(var c=0;c<b.length;c++)B.data[a].hasOwnProperty(b[c])&&delete B.data[a][b[c]];return b.length}function q(a,b,c){for(var d="",e=0,f=0;f<b.length;f++){d=b[f];var g=c(u(B.data[a][d]));if(g){delete g.ID;var h=B.data[a][d];for(var i in g)g.hasOwnProperty(i)&&(h[i]=g[i]);B.data[a][d]=w(a,h),e++}}return e}function r(){C[z]=JSON.stringify(B)}function s(){return JSON.stringify(B)}function t(a){throw new Error(a)}function u(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function v(a){return!a.match(/[^a-z_0-9]/gi)}function w(a,b){for(var c="",d={},e=0;e<B.tables[a].fields.length;e++)c=B.tables[a].fields[e],b[c]&&(d[c]=b[c]);return d}function x(a,b){for(var c="",d={},e=0;e<B.tables[a].fields.length;e++)c=B.tables[a].fields[e],d[c]=b[c]?b[c]:null;return d}var y="db_",z=y+a,A=!1,B=null;try{var C=b==sessionStorage?sessionStorage:localStorage}catch(a){var C=b}return B=C[z],B&&(B=JSON.parse(B))&&B.tables&&B.data||(v(a)?(B={tables:{},data:{}},r(),A=!0):t("The name '"+a+"' contains invalid characters.")),{commit:function(){r()},isNew:function(){return A},drop:function(){c()},serialize:function(){return s()},tableExists:function(a){return e(a)},tableCount:function(){return d()},createTable:function(a,b){var c=!1;if(v(a))if(this.tableExists(a))t("The table name '"+a+"' already exists.");else{for(var d=!0,e=0;e<b.length;e++)if(!v(b[e])){d=!1;break}if(d){for(var f={},e=0;e<b.length;e++)f[b[e]]=!0;delete f.ID,b=["ID"];for(var h in f)f.hasOwnProperty(h)&&b.push(h);g(a,b),c=!0}else t("One or more field names in the table definition contains invalid characters.")}else t("The database name '"+a+"' contains invalid characters.");return c},dropTable:function(a){f(a),h(a)},truncate:function(a){f(a),i(a)},rowCount:function(a){return f(a),j(a)},insert:function(a,b){return f(a),k(a,x(a,b))},insertOrUpdate:function(a,b,c){f(a);var d=[];if(b?"object"==typeof b?d=m(a,w(a,b)):"function"==typeof b&&(d=n(a,b)):d=o(a),0==d.length)return k(a,x(a,c));for(var e=[],g=0;g<d.length;g++)q(a,d,function(a){return e.push(a.ID),c});return e},update:function(a,b,c){f(a);var d=[];return b?"object"==typeof b?d=m(a,w(a,b)):"function"==typeof b&&(d=n(a,b)):d=o(a),q(a,d,c)},query:function(a,b,c){f(a);var d=[];return b?"object"==typeof b?d=m(a,w(a,b),c):"function"==typeof b&&(d=n(a,b,c)):d=o(a,c),l(a,d,c)},deleteRows:function(a,b){f(a);var c=[];return b?"object"==typeof b?c=m(a,w(a,b)):"function"==typeof b&&(c=n(a,b)):c=o(a),p(a,c)}}}