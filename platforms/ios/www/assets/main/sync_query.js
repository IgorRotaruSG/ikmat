function selectTaskById(a,b){d=db.getDbInstance(),d.transaction(function(c){c.executeSql('SELECT * FROM "sync_query" WHERE "id"=? and executed=1',[a],function(c,d){b(d.rows.length>0?d.rows.item(0):{extra:a})})})}function sync_updateDB(a,b){d=db.getDbInstance();try{b&&b.id&&d.transaction(function(c){var d={};if(a){var e=a;"formDeviationStart"==b.api&&(e=a.form_deviation.last_task_inserted),d.sql='UPDATE "sync_query" SET "executed"=?,"extra"=? WHERE "id"=?',d.args=[1,e,b.id]}else d.sql='UPDATE "sync_query" SET "executed"=? WHERE "id"=?',d.args=[1,b.id];c.executeSql(d.sql,d.args,function(){_sync_lock=!1,_sync_data_i=parseInt(_sync_data_i)+1,(_sync_data_i>=_sync_data_rows.length||!_sync_data_rows)&&($("#syncing_tasks").addClass("hide"),$(".overflow-wrapper").addClass("overflow-wrapper-hide")),sync_query(a,b)})})}catch(c){_sync_lock=!1,_sync_data_i=parseInt(_sync_data_i)+1,console.error("wtf"),sync_query()}}function sync_query(a,b){if(isOffline())return _sync_data_rows=!1,_sync_lock=!1,$("#syncing_tasks").addClass("hide"),void $(".overflow-wrapper").addClass("overflow-wrapper-hide");if(_sync_data_rows)if(_sync_data_i<_sync_data_rows.length&&!_sync_lock){$("#syncing_tasks").hasClass("hide")&&$("#syncing_tasks").removeClass("hide"),$(".overflow-wrapper").removeClass("overflow-wrapper-hide");var c=object=$.extend({},_sync_data_rows.item(_sync_data_i));try{c.data=JSON.parse(c.data),c.data.client=User.client,c.data.token=User.lastToken,_sync_lock=!0,"uploadPhotos"==c.api?(console.log("uploadPhotos",c),selectTaskById(c.extra,function(a){console.log("success",a),a.extra&&(a.data=JSON.parse(a.data),c.data.task_id=a.extra,c.data.imageURI&&c.data.task_id&&Page.uploadImage(c.data,function(){sync_updateDB(null,{id:c.id})},function(){sync_updateDB(null,{id:c.id})}))})):c.extra&&c.extra>0?selectTaskById(c.extra,function(a){if(console.log("success",a),a.extra){if(a.data=JSON.parse(a.data),c.data.hasOwnProperty("task_id")&&(c.data.task_id=a.extra),c.data.form){var b=JSON.parse(c.data.form);b.task_id=a.extra,c.data.form=JSON.stringify(b)}if(c.data.signature){var d=JSON.parse(c.data.signature);d.task_id=a.extra,c.data.signature=JSON.stringify(d)}if(c.data.results){var e=JSON.parse(c.data.results);e.task_id=a.extra,c.data.results=JSON.stringify(e)}Page.apiCall(c.api,c.data,"post","sync_updateDB",{id:c.id,api:c.api})}}):Page.apiCall(c.api,c.data,"post","sync_updateDB",{id:c.id,api:c.api})}catch(e){console.error("wtf"),sync_query()}}else _sync_data_i>0&&(_sync_lock=!1,_sync_data_rows=!1,$("#syncing_tasks").addClass("hide"),$(".overflow-wrapper").addClass("overflow-wrapper-hide"),window.location.reload());else d.transaction(function(a){a.executeSql('SELECT * FROM "sync_query" WHERE "executed"=?',[0],function(a,b){_sync_data_rows=b.rows,console.log("_sync_data_rows",_sync_data_rows),_sync_data_i=0,sync_query()})})}var _sync_data_rows=!1,_sync_data_i=0,_sync_lock=!1;