function maintenanceInit(){get=Page.get();var a={client:User.client,token:User.lastToken};void 0!=get.id&&(a.task_id=get.id),isOffline()?db.getDbInstance("tasks").get(a.task_id,function(a,b){if(b&&!b.completed){var c=JSON.parse(b.taskData);maintenance(c)}}):Page.apiCall("maintenance",a,"get","maintenance")}function maintenance(a){if(a.form_deviation){var b=HTML.formGenerate(a.form_deviation,$.t("general.save_button"));b+='<div data-role="popup" data-history="false" id="signature_pop" data-overlay-theme="d" data-theme="a" style="padding:20px;border: 0;" data-corners="false" data-tolerance="15,15"><div id="signature-holder"><div id="signature" data-role="none"></div></div><button id="deviation-signature-close">'+$.t("general.sign_button")+"</button></div></div>",$("#form_maintenance").html(b),$("#signature-trigger").off("click").on("click",function(a){return a.preventDefault(),openSignaturePopup(),$(document).off("click","#deviation-signature-close").on("click","#deviation-signature-close",function(){$("#signature_pop").popup("close"),$("#sign_name").attr("disabled",!0),$("#signature-trigger").attr("disabled",!0),$("#signature-trigger").val("Signed").button("refresh")}),!1}),$("#form_maintenance").on("submit",function(a){a.preventDefault();var b=HTML.validate($(this));if(b){$(".overflow-wrapper").removeClass("overflow-wrapper-hide");var c=HTML.getFormValues($(this).parent()),d={client:User.client,token:User.lastToken,results:JSON.stringify(c)};Page.apiCall("maintenance",d,"get","maintenanceDone")}return!1}),$("#"+$.mobile.activePage.attr("id")).trigger("create"),$(".overflow-wrapper").addClass("overflow-wrapper-hide")}if(a.form_fix_deviation){var c=new Date(a.form_fix_deviation.deviation_date.date.replace(" ","T")),b="<h3>"+$.t("tasks.maintenance_fix")+"</h3>";if(void 0!=a.form_fix_deviation.deviation_photos&&a.form_fix_deviation.deviation_photos.length>0){var d=$.parseJSON(a.form_fix_deviation.deviation_photos);console.log(d);for(var e in d)d.hasOwnProperty(e)&&(b+='<img width="100%" height="auto" style="margin:0 auto;" src="'+d[e]+'" />')}b+='<fieldset data-role="controlgroup">'+$.t("general.maintenance_need")+" : "+a.form_fix_deviation.deviation.replace(/\+/g," ")+"</div>",b+='<fieldset data-role="controlgroup">'+$.t("general.planned_measures")+" : "+a.form_fix_deviation.initial_action.replace(/\+/g," ")+"</div>",b+='<fieldset data-role="controlgroup">'+$.t("general.maintenance_date")+" : "+c.getDate()+"."+(parseInt(c.getMonth())+1)+"."+c.getFullYear()+"</div>",b+='<fieldset data-role="controlgroup">'+$.t("general.maintenance_responsible")+" : "+a.form_fix_deviation.form.responsible_fix_deviation.value+"</div>",b+="<hr />",b+=HTML.formGenerate(a.form_fix_deviation.form,$.t("general.save_button")),$("#form_maintenance").html(b).off("submit").on("submit",function(a){a.preventDefault();var b=Form.validate($(this));if(b){$(".overflow-wrapper").removeClass("overflow-wrapper-hide");var c=Form.getValues($(this)),d={client:User.client,token:User.lastToken,task_id:get.id,results:JSON.stringify(c)};console.log("submit"),isOffline()?db.lazyQuery("sync_query",[{api:"maintenance",data:JSON.stringify(d),extra:get.id,q_type:"maintenanceDone"}],function(a){if(a&&a.length>0){var b=a[0].id;$.isNumeric(b)&&$('input[name="task_id"]').val(get.id),maintenanceDone(get.id)}}):Page.apiCall("maintenance",d,"get","maintenanceDone")}return!1}),$("#"+$.mobile.activePage.attr("id")).trigger("create"),$(".overflow-wrapper").addClass("overflow-wrapper-hide"),$("#form_back_btn i").removeClass("hided")}calcHeight("form_maintenance")}function calcHeight(a){$("#"+a).parent().css("overflow-y","scroll"),$("#"+a).parent().css("overflow-x","hidden"),$("#"+a).parent().css("position","relative"),$("#"+a).parent().css("height",document.body.clientHeight-80+"px"),$("#"+a).parent().css("-webkit-overflow-scrolling","touch")}function documentSignature(a){$("#sign_name").attr("disabled",!0),$("#signature-trigger").attr("disabled",!0),$("#signature-trigger").val(a.current_time.date).button("refresh")}function checkTaskId(a,b){return b?void db.getDbInstance("sync_query").get(a,function(a,c){b(c&&c.executed?!0:!1)}):!1}function maintenanceDone(a){$.isNumeric(get.id)&&$('input[name="task_id"]').val(get.id),uploadMaintenancePicture(),db.lazyQuery("tasks",[{_id:String(get.id),completed:!0}],function(){console.log("update"),Page.redirect("tasks.html")})}function uploadMaintenancePicture(){var a=$("#"+haccp_image_id),b=a.attr("src");b&&Page.uploadImage(b,{role:"fixed"},function(b){a.css({visibility:"hidden",display:"none"}).attr("src","")})}var get;$(document).on("click","#form_back_btn",function(a){a.preventDefault(),$("[href='tasks.html']").click()});