function selectTaskById(a,b){db.getDbInstance("sync_query").get(a,function(c,d){b(d&&d.executed?d:{extra:a})})}function sync_updateDB(a,b){console.log("sync_updateDB",a,b);try{if(b&&b.id){var c=[];if(a){var d=a;"formDeviationStart"==b.api&&(d=a.form_deviation.last_task_inserted),c=[{executed:1,extra:d,_id:b.id}]}else c=[{executed:1,_id:b.id}];db.lazyQuery("sync_query",c,function(){console.log("sync_query updae",b.id),_sync_lock=!1,_sync_data_i=parseInt(_sync_data_i)+1,(_sync_data_i>=_sync_data_rows.length||!_sync_data_rows)&&($("#syncing_tasks").addClass("hide"),$(".overflow-wrapper").addClass("overflow-wrapper-hide")),sync_query(a,b)})}}catch(e){_sync_lock=!1,_sync_data_i=parseInt(_sync_data_i)+1,console.error("wtf"),sync_query()}}function sync_query(a,b){if(isOffline())return _sync_data_rows=!1,_sync_lock=!1,$("#syncing_tasks").addClass("hide"),void $(".overflow-wrapper").addClass("overflow-wrapper-hide");if(_sync_data_rows)if(_sync_data_i<_sync_data_rows.length&&!_sync_lock){$("#syncing_tasks").hasClass("hide")&&$("#syncing_tasks").removeClass("hide"),$(".overflow-wrapper").removeClass("overflow-wrapper-hide");var c=object=$.extend({},_sync_data_rows[_sync_data_i].doc);console.log("test _sync_data_i",c,c._id);try{c.data=JSON.parse(c.data),c.data.client=User.client,c.data.token=User.lastToken,_sync_lock=!0,"uploadPhotos"==c.api?selectTaskById(c.extra,function(a){a.extra&&(c.data.task_id=a.extra,c.data.imageURI&&c.data.task_id&&Page.uploadImage(c.data,function(){sync_updateDB(null,{id:c._id})},function(){sync_updateDB(null,{id:c._id})}))}):"companyEdit"!=c.api?selectTaskById(c.extra,function(a){if(a.extra){if(c.data.hasOwnProperty("task_id")&&(c.data.task_id=a.extra),c.data.form){var b=JSON.parse(c.data.form);b.task_id=a.extra,c.data.form=JSON.stringify(b)}if(c.data.signature){var d=JSON.parse(c.data.signature);d.task_id=a.extra,c.data.signature=JSON.stringify(d)}if(c.data.results){var e=JSON.parse(c.data.results);e.task_id=a.extra,c.data.results=JSON.stringify(e)}Page.apiCall(c.api,c.data,"post","sync_updateDB",{id:c._id,api:c.api})}else Page.apiCall(c.api,c.data,"post","sync_updateDB",{id:c._id,api:c.api})}):Page.apiCall(c.api,c.data,"post","sync_updateDB",{id:c._id,api:c.api})}catch(d){console.error("wtf"),sync_query()}}else _sync_data_i>0&&(_sync_lock=!1,_sync_data_rows=!1,$("#syncing_tasks").addClass("hide"),$(".overflow-wrapper").addClass("overflow-wrapper-hide"),window.location.reload());else db.getDbInstance("sync_query").query(function(a,b){a.executed||b(a)},{include_docs:!0},function(a,b){console.log("test",a,b),_sync_data_rows=b.rows,console.log("_sync_data_rows",_sync_data_rows),_sync_data_i=0,sync_query()})}var _sync_data_rows=!1,_sync_data_i=0,_sync_lock=!1;